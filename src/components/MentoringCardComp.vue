<template>
	<div class="card-view">
		<div
			v-for="(mentoring, index) in mentoringsContent"
			:key="index"
			class="mentoring-card"
			@click="goToMentoring(mentoring.id)"
		>
			<img
				:src="
					mentoring.thumbnailUrl
						? mentoring.thumbnailUrl
						: 'https://picsum.photos/id/1/200/300'
				"
				class="mentoring-thumbnail"
			/>
			<div class="card-contents">
				<div class="mentoring-category">
					{{ getCategoryLabel(mentoring.category) }}
				</div>
				<div class="hashtags">
					<span
						v-for="(hashtag, index) in mentoring.hashtags"
						:key="index"
						class="hashtag"
					>
						#{{ hashtag }}
					</span>
				</div>
				<h3 class="mentoring-title">
					{{ mentoring.title }}
					<!-- 좋아요 여부를 question.likedByCurrentUser로 판별 -->
					<span
						class="likes"
						@click.stop="toggleLike(mentoring)"
						style="margin-left: auto"
					>
						<!-- 좋아요 상태가 true면 ❤️ 아이콘, false면 🤍 아이콘을 표시 -->
						<span v-if="mentoring.likedByCurrentUser">❤️</span>
						<span v-else>🤍</span>
						{{ mentoring.likeCount }}
					</span>
				</h3>
				<p class="mentoring-summary">{{ mentoring.summary }}</p>
				<div class="author-info">
					<img
						:src="
							mentoring.author.profileUrl
								? mentoring.author.profileUrl
								: 'https://picsum.photos/id/1/50/50'
						"
						alt=""
						class="author-profile"
					/>
					<div class="author-details">
						<div class="author-name">{{ mentoring.author.name }} 멘토</div>
						<div class="mentoring-price">1회 {{ mentoring.price }}원</div>
					</div>
					<div class="author-rating" @click.stop="handleButtonClick">
						<span class="rating-star">⭐</span>
						{{ Math.round(mentoring.averageRating * 10) / 10 }}
					</div>
				</div>
			</div>
		</div>
	</div>
	<ReviewOfMentoringComp
		v-if="showModal"
		@close="closeModal"
		:mentoringId="selectedMentoringId"
	></ReviewOfMentoringComp>
</template>

<script setup>
import { useQandMStore } from '@/stores/questionAndMentoringStore';
import { useCategoryStore } from '@/stores/category';
import { useRouter } from 'vue-router';
import { computed } from 'vue';
import { storeToRefs } from 'pinia';
import { ref } from 'vue';

import ReviewOfMentoringComp from './ReviewOfMentoringComp.vue';

const mentoringStore = useQandMStore();
const { mentoringList } = storeToRefs(mentoringStore);

const router = useRouter();

const mentoringsContent = computed(() => mentoringList.value.content || []);

// 클릭 시 멘토링 상세 페이지로 이동
const goToMentoring = mentoringId => {
	router.push({ path: `/mentoring/${mentoringId}` });
};

// 좋아요 상태를 question.likedByCurrentUser로 판별하고 토글하는 함수
const toggleLike = mentoring => {
	// 현재 좋아요 상태를 변경
	if (mentoring.likedByCurrentUser) {
		mentoring.likedByCurrentUser = false;
		mentoring.likeCount--;
	} else {
		mentoring.likedByCurrentUser = true;
		mentoring.likeCount++;
	}
};

// 카테고리 이름을 가져오는 함수
const categoryStore = useCategoryStore();
const { categories } = storeToRefs(categoryStore);

const getCategoryLabel = value => {
	const category = categories.value.find(cat => cat.value === value);
	return category ? category.label : value;
};

const selectedMentoringId = ref(null);

const showModal = ref(false);

const handleButtonClick = () => {
	showModal.value = true;
};

const closeModal = () => {
	showModal.value = false;
};
</script>

<style scoped>
.card-view {
	display: grid;
	grid-template-columns: repeat(4, 1fr);
	gap: 30px;
	justify-content: center;
}

.mentoring-card {
	position: relative; /* 자식 요소의 위치 기준을 설정 */
	overflow: hidden;
	cursor: pointer;
	transition: transform 0.2s;
	height: 450px;
	display: flex;
	flex-direction: column;
}

.mentoring-card:hover {
	transform: scale(1.05);
}

.mentoring-category {
	color: #3b946f;
	font-weight: 600;
}

.mentoring-thumbnail {
	width: 100%;
	height: 50%;
	object-fit: fill;
	border-radius: 5px;
	margin-bottom: 6px;
}

.likes {
	font-size: 16px;
	color: black;
	display: inline-flex;
	align-items: center;
	margin-left: 10px;
}

.hashtags {
	margin: 5px 0;
}

.hashtag {
	display: inline-block;
	background-color: #cdcdcd;
	padding: 2px 5px;
	border-radius: 5px;
	margin-right: 5px;
	font-size: 10px;
	font-weight: 400;
	color: black;
}

.mentoring-title {
	font-size: 1.2em;
	font-weight: bold;
	margin: 5px 0;
	display: flex;
	align-items: center;
	justify-content: space-between;
	white-space: nowrap; /* 텍스트가 줄바꿈되지 않도록 설정 */
	overflow: hidden; /* 넘치는 텍스트를 숨김 처리 */
	text-overflow: ellipsis; /* 넘치는 텍스트에 ... 표시 */
	width: 80%; /* 텍스트가 박스의 가로 80%만 차지하도록 설정 */
	/* 위의 스타일은 길어질 때 제목이 잘리지 않고 ...으로 표시되도록 함 */
}

.mentoring-summary {
	font-size: 12px;
	color: #444;
	margin-bottom: 26px;
	margin-left: 5px;
	overflow: hidden; /* 넘치는 텍스트를 숨김 처리 */
	text-overflow: ellipsis; /* 넘치는 텍스트에 ... 표시 */
	display: -webkit-box; /* Flexbox와 유사한 스타일로 표시 */
	-webkit-line-clamp: 2; /* 최대 2줄까지만 표시하고 잘린 텍스트는 ... 처리 */
	-webkit-box-orient: vertical; /* 수직 방향으로 클램프 적용 */
	width: 80%; /* 텍스트가 박스의 가로 80%만 차지하도록 설정 */
	/* 위의 스타일은 요약이 너무 길어질 경우 줄바꿈 후 ...으로 표시되도록 함 */
}

.author-info {
	display: flex;
	align-items: center;
	margin-bottom: 5px;
	height: 50px; /* 각 요소의 높이를 동일하게 설정 */
}

.author-profile {
	width: 40px;
	height: 40px;
	border-radius: 50%;
	object-fit: cover;
	margin-right: 10px;
	align-self: center; /* 프로필 이미지를 세로 중앙 정렬 */
}

.author-details {
	display: flex;
	flex-direction: column;
	justify-content: center; /* 세로 중앙 정렬 */
	height: 100%; /* author-info와 동일한 높이 설정 */
}

.author-rating {
	color: #f39c12;
	font-size: 16px;
	margin-left: auto;
	border-radius: 10px;
	background-color: #fff8ba;
	height: 80%; /* author-info와 동일한 높이 설정 */
	display: flex;
	align-items: center; /* 세로 중앙 정렬 */
	padding: 0 10px; /* 공간을 확보하여 배경이 잘 보이도록 */
}

.mentoring-price {
	font-weight: bold;
	font-size: 12px;
	color: black;
	margin-top: 5px; /* 상하 중앙 정렬을 위해 추가 */
}

.actions {
	display: flex;
	justify-content: flex-end;
	align-items: center;
	margin-top: auto;
}

.card-contents {
	padding: 5px 10px;
	border: 1px solid #ddd;
	border-radius: 10px;
}

.author-name {
	color: #3b946f;
	font-weight: 800;
	font-size: 15px;
}
</style>
